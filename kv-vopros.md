# Инструкция по проекту kv-vopros

## Краткое описание

Проект `kv-vopros` — это универсальный квиз для посадочных страниц, реализованный как компонент на базе October CMS. Исходный код приложения находится в папке `october/`. Проект содержит конфигурации для запуска через Docker (Traefik, Nginx, PHP-FPM, MySQL) и все необходимые зависимости для разработки и продакшена.

Основная логика квиза управляется фронтенд-компонентом, а его структура, вопросы и правила динамической подмены контента хранятся в конфигурационном JSON-файле.

---

## Зависимости (основные)

- **PHP**: требуется PHP >= 8.2 (см. `october/composer.json`).
- **Composer**: для установки PHP-зависимостей.
- **Node.js & npm/yarn**: для сборки фронтенд-ассетов (см. `october/package.json`).
- **Docker & docker-compose**: рекомендовано для локальной разработки.

---

## Архитектура проекта

### Структура директорий

```
kv-vopros/
├── docker-compose.yml      # Оркестрация Docker-сервисов
├── Dockerfile              # Образ PHP-FPM приложения
├── nginx/                  # Конфигурация веб-сервера
├── traefik/                # Конфигурация reverse-proxy
└── october/                # October CMS приложение
    ├── app/                # Кастомный код (при необходимости)
    ├── config/             # Конфигурационные файлы
    ├── plugins/            # Плагины (например, для сохранения лидов)
    └── themes/leademy/     # Тема сайта
        ├── assets/
        ├── pages/
        │   └── index.htm             # Пример страницы 
        └── partials/
```

---

## Важные файлы и за что они отвечают

### Docker и инфраструктура

- `docker-compose.yml` — конфигурация докер-окружения (Traefik, app, nginx, db).
- `Dockerfile` — образ PHP 8.2-FPM на Alpine Linux с необходимыми расширениями.
- `nginx/default.conf` — конфигурация nginx (кэширование статики, проксирование PHP).
- `traefik/traefik.yml` — статическая конфигурация Traefik (SSL, редиректы).

### October CMS приложение

- `october/.env` — переменные окружения (БД, ключи API и т.д.).
- `october/webpack.mix.js` — конфигурация сборки фронтенда (JS, CSS).
---


---

## Настройка October CMS для медиа и импорта/экспорта

Эти настройки необходимы для расширения стандартных возможностей CMS.

### 1. Поддержка новых форматов медиа (например, .avif)

Для загрузки современных форматов изображений через медиа-менеджер October CMS и их корректной обработки.

**1.1. Системные пакеты (Dockerfile)**

Убедитесь, что в `Dockerfile` для сборки PHP-образа установлена необходимая системная библиотека и расширение `gd` скомпилировано с ее поддержкой.

```dockerfile
# ...
RUN apk add --no-cache \
    libavif-dev \
    # ... другие пакеты

RUN docker-php-ext-configure gd --with-freetype --with-jpeg --with-webp --with-avif \
    && docker-php-ext-install gd
# ...
```

**1.2. Конфигурация October CMS (`config/system.php`)**

Разрешите загрузку нового формата в системной конфигурации.
- **Файл**: `october/config/system.php`
- **Действие**: Добавьте расширение (без точки) в массив `allowed_file_types`.

```php
'allowed_file_types' => [
    // ...
    'avif',
],
```
После изменения файла очистите кэш: `php artisan cache:clear`.

### 2. Настройка импорта данных Tailor

**ВАЖНО**: Этот раздел актуален, если вы решите хранить вопросы квиза или другие сущности в Tailor и управлять ими через импорт/экспорт. Стандартный импорт в October CMS имеет ограничения. Приведенные ниже правки системного файла `RecordImport.php` позволяют их обойти.

**Проблема**: Стандартный импорт требует `ID`, создает дубликаты при обновлении и не обрабатывает пустые даты.

**Решение**: После каждого обновления ядра October CMS необходимо вручную вносить правки в файл `/october/modules/tailor/models/RecordImport.php`.

**1. Разрешить импорт без ID (строки ~65-73)**
   - **Найти**: Блок, проверяющий `array_get($data, 'id')`.
   - **Заменить на**: Логику, которая ищет запись по `slug` или `title`, если `id` отсутствует.

**2. Убрать блокировку обновления (строки ~78-85)**
   - **Найти**: Условие `if (!$this->update_existing)`.
   - **Заменить на**: Код, который всегда разрешает обновление, если запись найдена.

**3. Исключить ID из обновлений и обработать пустые даты (строки ~88-95)**
   - **Найти**: Цикл `foreach ($data as $attr => $value)`.
   - **Заменить на**: Модифицированный цикл, который пропускает поле `id` для существующих записей и конвертирует пустые строки в `null` для полей дат.

**4. Изменить метод поиска дубликатов (строки ~106-118)**
   - **Найти**: Метод `findDuplicateRecord($data)`.
   - **Заменить на**: Расширенную логику, которая ищет дубликат не только по `id`, но и по `title` или `slug`.

> **Подробный код для этих правок** можно найти в файле `INSTRUCTIONS.md` в репозитории `leademy-digital`. Эти изменения делают импорт/экспорт данных (например, вопросов квиза) гораздо более гибким и удобным.

---

## Часто используемые команды

- Поднять окружение (Docker):
  ```bash
  docker compose up -d
  ```
- Остановить окружение:
  ```bash
  docker compose down
  ```
- Выполнить artisan-команду в контейнере приложения:
  ```bash
  docker compose exec app php artisan <команда>
  ```
- Установить PHP-зависимости (внутри контейнера):
  ```bash
  docker compose exec app composer install
  ```
- Установить Node-зависимости и собрать ассеты:
  ```bash
  # Внутри контейнера app
  docker compose exec app npm install
  docker compose exec app npm run dev # или npm run production
  ```
- Очистить кэш October CMS:
  ```bash
  docker compose exec app php artisan cache:clear
  docker compose exec app php artisan view:clear
  ```

---

## Переменные окружения (.env)

Ключевые переменные в файле `october/.env`:

| Переменная | Описание |
|------------|----------|
| `APP_KEY` | Ключ шифрования (генерируется командой `php artisan key:generate`) |
| `APP_URL` | Базовый URL сайта (например, https://your-domain.com) |
| `APP_ENV` | Окружение (`production` или `local`) |
| `DB_HOST` | Хост БД (в Docker-окружении это `db`) |
| `DB_DATABASE` | Имя базы данных |
| `DB_USERNAME` | Пользователь БД |
| `DB_PASSWORD` | Пароль БД |
| `CRM_ENDPOINT_URL` | URL эндпоинта CRM для отправки данных квиза (опционально) |
| `CRM_API_KEY` | Ключ API для CRM (опционально) |

---

## Рекомендации по деплою

- Всегда храните чувствительные переменные в `october/.env`, а в репозитории — файл `.env.example` с шаблоном.
- Директории `storage/` и `bootstrap/cache` должны быть доступны для записи веб-сервером.
- Перед обновлениями ядра или плагинов обязательно делайте бэкап базы данных и директории `storage/`.
- После деплоя не забывайте выполнять миграции и очищать кэш.

---

*Документация актуализирована: Декабрь 2025*

